<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodTracker - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css?v=8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load config.js first (if exists) for API keys -->
    <script src="config.js" onerror="console.log('config.js not found - using default API keys')"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1>üë®‚Äçüíº Admin Dashboard</h1>
                <p id="adminGreeting">Manage Users</p>
            </div>
            <button onclick="auth.signOut()" class="btn-danger">üö™ Sign Out</button>
        </div>

        <!-- Users List -->
        <div class="calendar-container">
            <h2>üìã Assigned Users</h2>
            <div id="usersList" style="margin-top: 20px;">
                <p>Loading users...</p>
            </div>
        </div>
    </div>

    <!-- User Summary Modal -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="summaryUserName">User Summary</h2>
                <button class="close-btn" onclick="closeSummaryModal()">√ó</button>
            </div>
            <div style="display: grid; gap: 15px;">
                <div>
                    <label>Year:</label>
                    <select id="summaryYear"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);"></select>
                </div>
                <div>
                    <label>Month:</label>
                    <select id="summaryMonth"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <button onclick="generateSummary('monthly')" class="btn btn-primary">üóì Monthly Summary</button>

                <div>
                    <label>Week (1-5):</label>
                    <select id="summaryWeek"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);">
                        <option value="1">Week 1 (Days 1-7)</option>
                        <option value="2">Week 2 (Days 8-14)</option>
                        <option value="3">Week 3 (Days 15-21)</option>
                        <option value="4">Week 4 (Days 22-28)</option>
                        <option value="5">Week 5 (Days 29+)</option>
                    </select>
                </div>
                <button onclick="generateSummary('weekly')" class="btn btn-primary">üìÜ Weekly Summary</button>

                <div>
                    <label>Day:</label>
                    <input type="number" id="summaryDay" min="1" max="31" value="1"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);">
                </div>
                <button onclick="generateSummary('daily')" class="btn btn-primary">üìÖ Daily Summary</button>
            </div>
        </div>
    </div>

    <!-- Chart Display Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="chartTitle">Summary</h2>
                <button class="close-btn" onclick="closeChartModal()">√ó</button>
            </div>
            <canvas id="summaryChart"></canvas>
        </div>
    </div>

    <!-- User History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="historyUserName">User History</h2>
                <button class="close-btn" onclick="closeHistoryModal()">√ó</button>
            </div>
            <div id="historyContent" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Recommendation Modal -->
    <div id="recommendationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recommendationUserName">Send Recommendation</h2>
                <button class="close-btn" onclick="closeRecommendationModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Message:</label>
                <textarea id="recommendationText" rows="6"
                    style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit;"
                    placeholder="Type your recommendation or advice..."></textarea>
            </div>
            <button onclick="sendRecommendation()" class="btn btn-primary">Send to User</button>
        </div>
    </div>

    <script src="api.js?v=4"></script>
    <script>
        // Check authentication and role
        if (!auth.isAuthenticated() || auth.getRole() !== 'admin') {
            window.location.href = 'index.html';
        }

        const email = localStorage.getItem('userEmail');
        document.getElementById('adminGreeting').textContent = `Welcome, Admin ${email}!`;

        let currentUserId = null;
        let currentChart = null;

        // Setup year selector
        const yearSelect = document.getElementById('summaryYear');
        const currentYear = new Date().getFullYear();
        for (let y = 2020; y <= 2030; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            if (y === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }
        document.getElementById('summaryMonth').value = new Date().getMonth() + 1;

        // Load users
        async function loadUsers() {
            try {
                const users = await admin.getAllUsers();
                displayUsers(users || {});
            } catch (error) {
                document.getElementById('usersList').innerHTML =
                    `<p style="color: var(--danger);">Error loading users: ${error.message}</p>`;
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersList');

            if (Object.keys(users).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No users assigned yet.</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 15px;">';

            Object.entries(users).forEach(([uid, userData]) => {
                html += `
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: var(--shadow);">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">
                            üë§ ${userData.fullname || 'Unknown'}
                        </h3>
                        <p><strong>Email:</strong> ${userData.email || 'N/A'}</p>
                        <p><strong>Role:</strong> ${userData.role || 'user'}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="showUserSummary('${uid}', '${userData.fullname || 'User'}')" class="btn-secondary">
                                üìä Summary
                            </button>
                            <button onclick="showUserHistory('${uid}', '${userData.fullname || 'User'}')" class="btn-secondary">
                                üìã History
                            </button>
                            <button onclick="showRecommendation('${uid}', '${userData.fullname || 'User'}')" class="btn-secondary">
                                ‚úçÔ∏è Recommend
                            </button>
                            <button onclick="deleteUser('${uid}', '${userData.email}')" class="btn-danger">
                                ‚ùå Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Summary functions
        function showUserSummary(uid, name) {
            currentUserId = uid;
            document.getElementById('summaryUserName').textContent = `Summary for ${name}`;
            document.getElementById('summaryModal').classList.add('active');
        }

        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.remove('active');
        }

        async function generateSummary(mode) {
            if (!currentUserId) return;

            const year = parseInt(document.getElementById('summaryYear').value);
            const month = parseInt(document.getElementById('summaryMonth').value);

            let startDate, endDate;

            if (mode === 'daily') {
                const day = parseInt(document.getElementById('summaryDay').value);
                startDate = endDate = new Date(year, month - 1, day);
            } else if (mode === 'weekly') {
                const week = parseInt(document.getElementById('summaryWeek').value);
                const startDay = 1 + (week - 1) * 7;
                startDate = new Date(year, month - 1, startDay);
                const endDay = Math.min(startDay + 6, new Date(year, month, 0).getDate());
                endDate = new Date(year, month - 1, endDay);
            } else {
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0);
            }

            try {
                const allMoods = await admin.getUserMoods(currentUserId);
                const counts = {};

                if (allMoods && typeof allMoods === 'object') {
                    Object.entries(allMoods).forEach(([y, months]) => {
                        if (typeof months !== 'object') return;
                        Object.entries(months).forEach(([m, days]) => {
                            if (typeof days !== 'object') return;
                            Object.entries(days).forEach(([d, entries]) => {
                                const date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
                                if (date >= startDate && date <= endDate) {
                                    if (Array.isArray(entries)) {
                                        entries.forEach(e => {
                                            if (e.mood) {
                                                counts[e.mood] = (counts[e.mood] || 0) + 1;
                                            }
                                        });
                                    }
                                }
                            });
                        });
                    });
                }

                if (Object.keys(counts).length === 0) {
                    alert('No moods found for this period');
                    return;
                }

                displayChart(counts, mode, startDate, endDate);
                closeSummaryModal();
            } catch (error) {
                alert('Error generating summary: ' + error.message);
            }
        }

        function displayChart(counts, mode, startDate, endDate) {
            const ctx = document.getElementById('summaryChart');

            if (currentChart) {
                currentChart.destroy();
            }

            const title = `${mode.charAt(0).toUpperCase() + mode.slice(1)} Summary (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`;
            document.getElementById('chartTitle').textContent = title;

            const chartType = mode === 'daily' ? 'pie' : 'bar';

            currentChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        label: 'Mood Count',
                        data: Object.values(counts),
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#ef4444', '#f59e0b',
                            '#8b5cf6', '#ec4899', '#f97316'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: { display: false }
                    }
                }
            });

            document.getElementById('chartModal').classList.add('active');
        }

        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('active');
        }

        // History functions
        async function showUserHistory(uid, name) {
            currentUserId = uid;
            document.getElementById('historyUserName').textContent = `History for ${name}`;
            const content = document.getElementById('historyContent');
            content.innerHTML = '<p>Loading history...</p>';
            document.getElementById('historyModal').classList.add('active');

            try {
                const allMoods = await admin.getUserMoods(uid);

                if (!allMoods || Object.keys(allMoods).length === 0) {
                    content.innerHTML = '<p>No mood history found.</p>';
                    return;
                }

                let html = '';
                // Flatten and sort moods by date (newest first)
                const flatMoods = [];

                Object.entries(allMoods).forEach(([year, months]) => {
                    Object.entries(months).forEach(([month, days]) => {
                        Object.entries(days).forEach(([day, entries]) => {
                            if (Array.isArray(entries)) {
                                entries.forEach(entry => {
                                    flatMoods.push({
                                        date: new Date(parseInt(year), parseInt(month) - 1, parseInt(day)),
                                        ...entry
                                    });
                                });
                            }
                        });
                    });
                });

                flatMoods.sort((a, b) => b.date - a.date);

                flatMoods.forEach(entry => {
                    html += `
                        <div style="background: var(--bg); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>${entry.date.toLocaleDateString()}</strong>
                                <span class="badge">${entry.mood}</span>
                            </div>
                            <div>Intensity: ${entry.intensity}/10</div>
                            ${entry.reflection ? `<div style="margin-top: 5px; font-style: italic;">"${entry.reflection}"</div>` : ''}
                        </div>
                    `;
                });

                content.innerHTML = html;

            } catch (error) {
                content.innerHTML = `<p style="color: var(--danger);">Error: ${error.message}</p>`;
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // Recommendation functions
        function showRecommendation(uid, name) {
            currentUserId = uid;
            document.getElementById('recommendationUserName').textContent = `Send Recommendation to ${name}`;
            document.getElementById('recommendationText').value = '';
            document.getElementById('recommendationModal').classList.add('active');
        }

        function closeRecommendationModal() {
            document.getElementById('recommendationModal').classList.remove('active');
        }

        async function sendRecommendation() {
            const message = document.getElementById('recommendationText').value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }

            try {
                await admin.sendRecommendation(currentUserId, message);
                alert('‚úÖ Recommendation sent successfully!');
                closeRecommendationModal();
            } catch (error) {
                alert('Error sending recommendation: ' + error.message);
            }
        }

        // Delete User
        async function deleteUser(uid, email) {
            if (!confirm(`Are you sure you want to delete user ${email}? This cannot be undone!`)) {
                return;
            }

            const confirmEmail = prompt(`Please type "${email}" to confirm deletion:`);
            if (confirmEmail !== email) {
                alert('Email mismatch. Deletion cancelled.');
                return;
            }

            try {
                await admin.deleteUser(uid);
                alert('‚úÖ User deleted successfully');
                loadUsers();
            } catch (error) {
                alert('Error deleting user: ' + error.message);
            }
        }

        // Initialize
        loadUsers();
    </script>
</body>

</html>