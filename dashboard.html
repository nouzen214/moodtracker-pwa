<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodTracker - Dashboard</title>
    <link rel="stylesheet" href="style.css?v=8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Load config.js first (if exists) for API keys -->
    <script src="config.js" onerror="console.log('config.js not found - using default API keys')"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1>ğŸŒŸ MoodTracker</h1>
                <p id="userGreeting">Welcome back!</p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="showSummaryOptions()" class="btn-secondary">ğŸ“Š Summaries</button>
                <button onclick="showMindfulness()" class="btn-secondary">ğŸ§˜ Mindfulness</button>
                <button id="messagesBtn" onclick="showMessages()" class="btn-secondary">âœ‰ï¸ Messages</button>
                <button onclick="showAIChat()" class="btn-secondary">ğŸ¤– AI Chat</button>
                <button onclick="auth.signOut()" class="btn-danger">ğŸšª Sign Out</button>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-container">
            <div class="calendar-header">
                <h2 id="calendarTitle">Loading...</h2>
                <div class="calendar-nav">
                    <button onclick="changeMonth(-1)">â† Prev</button>
                    <button onclick="changeMonth(1)">Next â†’</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- Mood Entry Modal -->
    <div id="moodModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="moodModalTitle">Mood Entry</h2>
                <button class="close-btn" onclick="closeMoodModal()">Ã—</button>
            </div>

            <!-- Existing Moods List -->
            <div id="existingMoods" style="margin-bottom: 20px;"></div>

            <h3 style="margin-bottom: 15px;">â• Add New Mood</h3>
            <form id="moodForm">
                <div class="form-group">
                    <label>ğŸ˜Š Select Mood</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <button type="button" class="mood-btn" data-mood="Happy ğŸ˜Š">ğŸ˜Š Happy</button>
                        <button type="button" class="mood-btn" data-mood="Sad ğŸ˜¢">ğŸ˜¢ Sad</button>
                        <button type="button" class="mood-btn" data-mood="Angry ğŸ˜ ">ğŸ˜  Angry</button>
                        <button type="button" class="mood-btn" data-mood="Anxious ğŸ˜°">ğŸ˜° Anxious</button>
                        <button type="button" class="mood-btn" data-mood="Neutral ğŸ˜">ğŸ˜ Neutral</button>
                        <button type="button" class="mood-btn" data-mood="Excited ğŸ¤©">ğŸ¤© Excited</button>
                        <button type="button" class="mood-btn" data-mood="Love â¤ï¸">â¤ï¸ Love</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ’ª Intensity (1-10): <span id="intensityValue">5</span></label>
                    <input type="range" id="intensity" min="1" max="10" value="5">
                </div>

                <div class="form-group">
                    <label>ğŸ“ Reflection (Optional)</label>
                    <textarea id="reflection" rows="4"
                        style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit;"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Save Mood</button>
            </form>
        </div>
    </div>

    <!-- Summary Options Modal -->
    <div id="summaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“Š Mood Summaries</h2>
                <button class="close-btn" onclick="closeSummaryModal()">Ã—</button>
            </div>
            <div style="display: grid; gap: 15px;">
                <div>
                    <label>Year:</label>
                    <select id="summaryYear"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);"></select>
                </div>
                <div>
                    <label>Month:</label>
                    <select id="summaryMonth"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <button onclick="showSummary('monthly')" class="btn btn-primary">ğŸ—“ Monthly Summary</button>

                <div>
                    <label>Week (1-5):</label>
                    <select id="summaryWeek"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);">
                        <option value="1">Week 1 (Days 1-7)</option>
                        <option value="2">Week 2 (Days 8-14)</option>
                        <option value="3">Week 3 (Days 15-21)</option>
                        <option value="4">Week 4 (Days 22-28)</option>
                        <option value="5">Week 5 (Days 29+)</option>
                    </select>
                </div>
                <button onclick="showSummary('weekly')" class="btn btn-primary">ğŸ“† Weekly Summary</button>

                <div>
                    <label>Day:</label>
                    <input type="number" id="summaryDay" min="1" max="31" value="1"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);">
                </div>
                <button onclick="showSummary('daily')" class="btn btn-primary">ğŸ“… Daily Summary</button>
            </div>
        </div>
    </div>

    <!-- Chart Display Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="chartTitle">Summary</h2>
                <button class="close-btn" onclick="closeChartModal()">Ã—</button>
            </div>
            <canvas id="summaryChart"></canvas>
        </div>
    </div>

    <!-- Mindfulness Modal -->
    <div id="mindfulnessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ§˜ Mindfulness Breathing</h2>
                <button class="close-btn" onclick="closeMindfulness()">Ã—</button>
            </div>
            <div style="text-align: center; padding: 40px 20px;">
                <p style="font-size: 1.2rem; margin-bottom: 30px;">Follow the breathing prompts below</p>
                <div id="breathingTimer"
                    style="font-size: 2.5rem; font-weight: bold; color: var(--primary); min-height: 80px; display: flex; align-items: center; justify-content: center;">
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messagesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœ‰ï¸ Admin Messages</h2>
                <button class="close-btn" onclick="closeMessages()">Ã—</button>
            </div>
            <div id="messagesList" style="max-height: 400px; overflow-y: auto;"></div>
            <button onclick="markMessagesRead()" class="btn btn-primary" style="margin-top: 15px;">Mark All as
                Read</button>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ¤– AI Chat</h2>
                <button class="close-btn" onclick="closeChatModal()">Ã—</button>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message ai">
                        Hi! I'm your mood tracking assistant. How are you feeling today?
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Type your message...">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // Check authentication
        if (!auth.isAuthenticated()) {
            window.location.href = 'index.html';
        }

        // Global variables
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let selectedDate = { year: currentYear, month: currentMonth, day: 1 };
        let selectedMood = null;
        let currentChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCalendar();
            setupMoodButtons();
            setupIntensitySlider();
            updateMessageBadge();

            const email = localStorage.getItem('userEmail');
            document.getElementById('userGreeting').textContent = `Welcome, ${email}!`;

            const yearSelect = document.getElementById('summaryYear');
            for (let y = 2020; y <= 2030; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }

            document.getElementById('summaryMonth').value = currentMonth;
        });

        // Calendar functions
        async function loadCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('calendarTitle').textContent =
                `${monthNames[currentMonth - 1]} ${currentYear}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.innerHTML = `<div>${day}</div>`;
                dayEl.onclick = () => openMoodModal(day);
                grid.appendChild(dayEl);
            }

            try {
                const moodsData = await moods.get(currentYear, currentMonth);
                if (moodsData && typeof moodsData === 'object') {
                    Object.entries(moodsData).forEach(([day, entries]) => {
                        if (Array.isArray(entries) && entries.length > 0) {
                            const dayNum = parseInt(day);
                            const dayElements = document.querySelectorAll('.calendar-day');
                            const dayEl = Array.from(dayElements)[firstDay + dayNum - 1];
                            if (dayEl) {
                                dayEl.classList.add('has-mood');
                                dayEl.innerHTML = `<div>${dayNum}</div><div style="font-size: 0.8rem;">(${entries.length})</div>`;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading moods:', error);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            loadCalendar();
        }

        // Mood modal functions
        async function openMoodModal(day) {
            selectedDate = { year: currentYear, month: currentMonth, day };
            document.getElementById('moodModalTitle').textContent = `Mood Entry - Day ${day}`;

            const existing = await moods.get(currentYear, currentMonth);
            const dayMoods = existing && existing[day] ? existing[day] : [];

            const existingDiv = document.getElementById('existingMoods');
            if (Array.isArray(dayMoods) && dayMoods.length > 0) {
                let html = '<div style="background: var(--bg); padding: 15px; border-radius: 10px; margin-bottom: 15px;">';
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
                html += `<h3>ğŸ“ Existing Moods (${dayMoods.length}/10)</h3>`;
                html += `<button onclick="deleteAllMoods()" class="btn-danger" style="padding: 8px 16px; font-size: 0.9rem;">ğŸ—‘ï¸ Delete All</button>`;
                html += `</div>`;
                dayMoods.forEach((entry, idx) => {
                    html += `<div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">`;
                    html += `<div><strong>${entry.mood}</strong> (Intensity: ${entry.intensity}/10)<br><small>${entry.reflection || 'No reflection'}</small></div>`;
                    html += `<button onclick="deleteMood(${idx})" class="btn-danger" style="padding: 6px 12px; font-size: 0.85rem;">Delete</button>`;
                    html += `</div>`;
                });
                html += '</div>';
                existingDiv.innerHTML = html;
            } else {
                existingDiv.innerHTML = '';
            }

            document.getElementById('moodModal').classList.add('active');
        }

        function closeMoodModal() {
            document.getElementById('moodModal').classList.remove('active');
            selectedMood = null;
            document.getElementById('moodForm').reset();
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
        }

        function setupMoodButtons() {
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.onclick = function () {
                    selectedMood = this.dataset.mood;
                    document.querySelectorAll('.mood-btn').forEach(b => {
                        b.style.background = '';
                        b.style.color = '';
                    });
                    this.style.background = 'var(--primary)';
                    this.style.color = 'white';
                };
            });
        }

        function setupIntensitySlider() {
            const slider = document.getElementById('intensity');
            const value = document.getElementById('intensityValue');
            slider.oninput = function () {
                value.textContent = this.value;
            };
        }

        // MOOD SAVE WITH AUTO AI RESPONSE (matching desktop app)
        document.getElementById('moodForm').onsubmit = async function (e) {
            e.preventDefault();

            if (!selectedMood) {
                alert('Please select a mood!');
                return;
            }

            const intensity = document.getElementById('intensity').value;
            const reflection = document.getElementById('reflection').value;

            try {
                // Capture mood before closing modal (which resets it)
                const currentMood = selectedMood;

                // Save the mood
                await moods.save(selectedDate.year, selectedDate.month, selectedDate.day,
                    selectedMood, parseInt(intensity), reflection);

                closeMoodModal();
                loadCalendar();

                // Automatically send to AI
                const aiMessage = `I felt ${currentMood} today with intensity ${intensity}/10. ${reflection}`;

                // Open AI chat modal
                showAIChat();

                // Add user message to chat
                addChatMessage(aiMessage, 'user');

                // Get AI response
                try {
                    const response = await ai.chat(aiMessage);
                    addChatMessage(response.response, 'ai');
                } catch (error) {
                    addChatMessage('Sorry, I encountered an error getting AI response.', 'ai');
                }

                alert('âœ… Mood saved! Check AI chat for response.');
            } catch (error) {
                alert('âŒ Error: ' + error.message);
            }
        };

        async function deleteMood(index) {
            if (!confirm('Delete this mood entry?')) return;

            try {
                await moods.delete(selectedDate.year, selectedDate.month, selectedDate.day, index);
                openMoodModal(selectedDate.day);
                loadCalendar();
            } catch (error) {
                alert('Error deleting mood: ' + error.message);
            }
        }

        async function deleteAllMoods() {
            if (!confirm('âš ï¸ Delete ALL mood entries for this day? This cannot be undone!')) return;

            try {
                await moods.deleteAll(selectedDate.year, selectedDate.month, selectedDate.day);
                closeMoodModal();
                loadCalendar();
                alert('âœ… All moods deleted!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Summary functions
        function showSummaryOptions() {
            document.getElementById('summaryModal').classList.add('active');
        }

        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.remove('active');
        }

        async function showSummary(mode) {
            const year = parseInt(document.getElementById('summaryYear').value);
            const month = parseInt(document.getElementById('summaryMonth').value);

            let startDate, endDate;

            if (mode === 'daily') {
                const day = parseInt(document.getElementById('summaryDay').value);
                startDate = endDate = new Date(year, month - 1, day);
            } else if (mode === 'weekly') {
                const week = parseInt(document.getElementById('summaryWeek').value);
                const startDay = 1 + (week - 1) * 7;
                startDate = new Date(year, month - 1, startDay);
                const endDay = Math.min(startDay + 6, new Date(year, month, 0).getDate());
                endDate = new Date(year, month - 1, endDay);
            } else {
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0);
            }

            const allMoods = await moods.getAll();
            const counts = {};

            if (allMoods && typeof allMoods === 'object') {
                Object.entries(allMoods).forEach(([y, months]) => {
                    if (typeof months !== 'object') return;
                    Object.entries(months).forEach(([m, days]) => {
                        if (typeof days !== 'object') return;
                        Object.entries(days).forEach(([d, entries]) => {
                            const date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
                            if (date >= startDate && date <= endDate) {
                                // FIX: Handle both Array and Object (dictionary)
                                let entriesList = [];
                                if (Array.isArray(entries)) {
                                    entriesList = entries;
                                } else if (typeof entries === 'object' && entries !== null) {
                                    entriesList = Object.values(entries);
                                }

                                entriesList.forEach(e => {
                                    if (e && e.mood) {
                                        counts[e.mood] = (counts[e.mood] || 0) + 1;
                                    }
                                });
                            }
                        });
                    });
                });
            }

            if (Object.keys(counts).length === 0) {
                alert('ğŸ˜¢ No moods found for this period');
                return;
            }

            displayChart(counts, mode, startDate, endDate);
            closeSummaryModal();
        }

        function displayChart(counts, mode, startDate, endDate) {
            const ctx = document.getElementById('summaryChart');

            if (currentChart) {
                currentChart.destroy();
            }

            const title = `${mode.charAt(0).toUpperCase() + mode.slice(1)} Summary (${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()})`;
            document.getElementById('chartTitle').textContent = title;

            const chartType = mode === 'daily' ? 'pie' : 'bar';

            currentChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        label: 'Mood Count',
                        data: Object.values(counts),
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#ef4444', '#f59e0b',
                            '#8b5cf6', '#ec4899', '#f97316'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: { display: false }
                    }
                }
            });

            document.getElementById('chartModal').classList.add('active');
        }

        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('active');
        }

        // Mindfulness
        function showMindfulness() {
            document.getElementById('mindfulnessModal').classList.add('active');
            startBreathing();
        }

        function closeMindfulness() {
            document.getElementById('mindfulnessModal').classList.remove('active');
        }

        function startBreathing() {
            const timer = document.getElementById('breathingTimer');
            const sequence = [
                { text: 'Inhale', duration: 4 },
                { text: 'Hold', duration: 4 },
                { text: 'Exhale', duration: 6 }
            ];

            let step = 0;
            let cycle = 0;
            const maxCycles = 3;

            function nextStep() {
                if (cycle >= maxCycles) {
                    timer.textContent = 'âœ… Done! Take a deep breath and relax.';
                    return;
                }

                const current = sequence[step];
                timer.textContent = `${current.text} for ${current.duration} seconds`;

                setTimeout(() => {
                    step++;
                    if (step >= sequence.length) {
                        step = 0;
                        cycle++;
                    }
                    nextStep();
                }, current.duration * 1000);
            }

            nextStep();
        }

        // Messages
        async function updateMessageBadge() {
            const count = await messages.getUnreadCount();
            const btn = document.getElementById('messagesBtn');
            if (count > 0) {
                btn.textContent = `âœ‰ï¸ Messages (${count} New)`;
                btn.style.background = 'var(--danger)';
            } else {
                btn.textContent = 'âœ‰ï¸ Messages';
                btn.style.background = '';
            }
        }

        async function showMessages() {
            const msgs = await messages.get();
            const list = document.getElementById('messagesList');

            if (!msgs || typeof msgs !== 'object' || Object.keys(msgs).length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-light);">No messages yet.</p>';
            } else {
                let html = '';
                Object.entries(msgs).forEach(([id, msg]) => {
                    const isNew = msg.status === 'new';
                    html += `<div style="background: ${isNew ? '#fef3c7' : 'var(--bg)'}; padding: 15px; border-radius: 10px; margin-bottom: 10px;">`;
                    html += `<div style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 5px;">${new Date(msg.timestamp).toLocaleString()}</div>`;
                    html += `<div>${msg.message}</div>`;
                    if (isNew) html += `<div style="color: var(--warning); font-weight: bold; margin-top: 5px;">â­ NEW</div>`;
                    html += `</div>`;
                });
                list.innerHTML = html;
            }

            document.getElementById('messagesModal').classList.add('active');
        }

        function closeMessages() {
            document.getElementById('messagesModal').classList.remove('active');
        }

        async function markMessagesRead() {
            await messages.markAsRead();
            updateMessageBadge();
            alert('âœ… All messages marked as read!');
            closeMessages();
        }

        // AI Chat
        function showAIChat() {
            document.getElementById('chatModal').classList.add('active');
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            try {
                const response = await ai.chat(message);
                addChatMessage(response.response, 'ai');
            } catch (error) {
                addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
            }
        }

        function addChatMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${sender}`;
            messageEl.textContent = text;
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        document.getElementById('chatInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>


</html>