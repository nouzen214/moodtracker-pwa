<!DOCTYPE html>
<p id="userGreeting">Welcome back!</p>
</div>
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <button onclick="showAIChat()" class="btn-secondary">ü§ñ AI Chat</button>
    <button onclick="auth.signOut()" class="btn-danger">üö™ Sign Out</button>
</div>
</div>

<!-- Calendar -->
<div class="calendar-container">
    <div class="calendar-header">
        <h2 id="calendarTitle">Loading...</h2>
        <div class="calendar-nav">
            <button onclick="changeMonth(-1)">‚Üê Prev</button>
            <button onclick="changeMonth(1)">Next ‚Üí</button>
        </div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
</div>
</div>

<!-- Mood Entry Modal -->
<div id="moodModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Mood Entry</h2>
            <button class="close-btn" onclick="closeMoodModal()">√ó</button>
        </div>
        <form id="moodForm">
            <div class="form-group">
                <label>üòä Select Mood</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button type="button" class="mood-btn" data-mood="happy">üòä Happy</button>
                    <button type="button" class="mood-btn" data-mood="sad">üò¢ Sad</button>
                    <button type="button" class="mood-btn" data-mood="angry">üò† Angry</button>
                    <button type="button" class="mood-btn" data-mood="anxious">üò∞ Anxious</button>
                    <button type="button" class="mood-btn" data-mood="calm">üòå Calm</button>
                    <button type="button" class="mood-btn" data-mood="excited">ü§© Excited</button>
                </div>
            </div>

            <div class="form-group">
                <label>üí™ Intensity (1-10)</label>
                <input type="range" id="intensity" min="1" max="10" value="5">
                <span id="intensityValue">5</span>
            </div>

            <div class="form-group">
                <label>üìù Reflection (Optional)</label>
                <textarea id="reflection" rows="4"
                    style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-family: inherit;"></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Save Mood</button>
        </form>
    </div>
</div>

<!-- AI Chat Modal -->
<div id="chatModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ü§ñ AI Chat</h2>
            <button class="close-btn" onclick="closeChatModal()">√ó</button>
        </div>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                    Hi! I'm your mood tracking assistant. How are you feeling today?
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Type your message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<script src="./js/api.js"></script>
<script>
    // Check authentication
    if (!auth.isAuthenticated()) {
        window.location.href = 'index.html';
    }

    // Global variables
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let selectedDate = null;
    let selectedMood = null;
    let chatHistory = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadCalendar();
        setupMoodButtons();
        setupIntensitySlider();

        // Set greeting
        const email = localStorage.getItem('userEmail');
        document.getElementById('userGreeting').textContent = `Welcome, ${email}!`;
    });

    // Calendar functions
    async function loadCalendar() {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];

        document.getElementById('calendarTitle').textContent =
            `${monthNames[currentMonth - 1]} ${currentYear}`;

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        // Get first day of month and number of days
        const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            grid.appendChild(emptyDay);
        }

        // Add days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = day;
            dayEl.onclick = () => openMoodModal(day);
            grid.appendChild(dayEl);
        }

        // Load moods and highlight days
        try {
            const moodsData = await moods.get();
            if (moodsData && moodsData.moods) {
                highlightMoodDays(moodsData.moods);
            }
        } catch (error) {
            console.error('Error loading moods:', error);
        }
    }

    function highlightMoodDays(moodsData) {
        // Parse moods data and highlight calendar days
        const yearData = moodsData[currentYear];
        if (!yearData) return;

        const monthData = yearData[currentMonth];
        if (!monthData) return;

        Object.keys(monthData).forEach(day => {
            const dayNum = parseInt(day);
            const dayElements = document.querySelectorAll('.calendar-day');
            const dayEl = Array.from(dayElements).find(el =>
                el.textContent == dayNum && !el.classList.contains('empty')
            );
            if (dayEl) {
                dayEl.classList.add('has-mood');
            }
        });
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 12) {
            currentMonth = 1;
            currentYear++;
        } else if (currentMonth < 1) {
            currentMonth = 12;
            currentYear--;
        }
        loadCalendar();
    }

    // Mood modal functions
    function openMoodModal(day) {
        selectedDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        document.getElementById('moodModal').classList.add('active');
    }

    function closeMoodModal() {
        document.getElementById('moodModal').classList.remove('active');
        selectedMood = null;
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.style.background = '';
            btn.style.color = '';
        });
    }

    function setupMoodButtons() {
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.onclick = function () {
                selectedMood = this.dataset.mood;
                document.querySelectorAll('.mood-btn').forEach(b => {
                    b.style.background = '';
                    b.style.color = '';
                });
                this.style.background = 'var(--primary)';
                this.style.color = 'white';
            };
        });
    }

    function setupIntensitySlider() {
        const slider = document.getElementById('intensity');
        const value = document.getElementById('intensityValue');
        slider.oninput = function () {
            value.textContent = this.value;
        };
    }

    document.getElementById('moodForm').onsubmit = async function (e) {
        e.preventDefault();

        if (!selectedMood) {
            alert('Please select a mood!');
            return;
        }

        const intensity = document.getElementById('intensity').value;
        const reflection = document.getElementById('reflection').value;

        try {
            await moods.save(selectedDate, selectedMood, parseInt(intensity), reflection);
            closeMoodModal();
            loadCalendar();
            alert('‚úÖ Mood saved successfully!');
        } catch (error) {
            alert('‚ùå Error saving mood: ' + error.message);
        }
    };

    // AI Chat functions
    function showAIChat() {
        document.getElementById('chatModal').classList.add('active');
    }

    function closeChatModal() {
        document.getElementById('chatModal').classList.remove('active');
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) return;

        // Add user message to chat
        addChatMessage(message, 'user');
        input.value = '';

        try {
            // Call AI API
            const response = await ai.chat(message, chatHistory);

            // Add AI response to chat
            addChatMessage(response.response, 'ai');

            // Update history
            chatHistory.push({ role: 'user', content: message });
            chatHistory.push({ role: 'assistant', content: response.response });

        } catch (error) {
            addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
        }
    }

    function addChatMessage(text, sender) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = `chat-message ${sender}`;
        messageEl.textContent = text;
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Allow Enter key to send message
    document.getElementById('chatInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>

<style>
    .mood-btn {
        padding: 12px;
        border: 2px solid var(--border);
        border-radius: 10px;
        background: white;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s;
    }

    .mood-btn:hover {
        border-color: var(--primary);
        transform: scale(1.05);
    }
</style>
</body>

</html>