<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Track your mood, improve your well-being">
    <link rel="manifest" href="app.webmanifest">
    <link rel="apple-touch-icon" href="logo.png">
    <title>MoodTracker - Sign In</title>
    <link rel="stylesheet" href="style.css?v=4">
</head>

<body>
    <div class="auth-container">
        <div class="auth-card">
            <img src="logo.png" alt="MoodTracker Logo" class="logo" onerror="this.style.display='none'">
            <h1>ðŸŒŸ MoodTracker</h1>
            <p class="subtitle">Track your mood, improve your well-being</p>

            <form id="signinForm" class="auth-form">
                <div class="form-group">
                    <label for="email">ðŸ“§ Email</label>
                    <input type="email" id="email" required placeholder="your@email.com">
                </div>

                <div class="form-group">
                    <label for="password">ðŸ”’ Password</label>
                    <input type="password" id="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>

                <button type="submit" class="btn btn-primary">Sign In</button>

                <p class="auth-link">
                    Don't have an account? <a href="signup.html">Sign Up</a>
                </p>
            </form>

            <div id="message" class="message"></div>
        </div>
    </div>

    <script src="api.js?v=4"></script>
    <script>
        // Check if already logged in
        if (auth.isAuthenticated()) {
            const role = auth.getRole();
            window.location.href = role === 'admin' ? 'admin.html' : 'dashboard.html';
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }

        // Handle sign in
        document.getElementById('signinForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                showMessage('Signing in...', 'info');
                const result = await auth.signIn(email, password);

                if (result.success) {
                    showMessage('Login successful! Redirecting...', 'success');

                    // Check if user has assigned admin (for regular users)
                    if (result.role === 'user') {
                        const hasAssignedAdmin = result.userInfo && result.userInfo.assigned_admin;

                        if (!hasAssignedAdmin) {
                            // Redirect to admin selection
                            setTimeout(() => {
                                window.location.href = 'admin-selection.html';
                            }, 1000);
                            return;
                        }
                    }

                    // Redirect based on role
                    setTimeout(() => {
                        if (result.role === 'admin') {
                            window.location.href = 'admin.html';
                        } else {
                            window.location.href = 'dashboard.html';
                        }
                    }, 1000);
                }
            } catch (error) {
                showMessage('Login failed: ' + error.message, 'error');
            }
        });

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered!'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>

</html>